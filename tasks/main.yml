---
- block:
  # Install Nessus agent for RedHat OS
  - include: RedHat.yml
    when: ansible_os_family == 'RedHat'
  
  # Install Nessus agent for Debian OS
  - include: Debian.yml
    when: ansible_os_family == 'Debian'
  when: nessus_install

- block:
  - name: Check for Nessus installation
    stat:
      path: "{{ nessus_install_dir }}"
    register: stat_result

  - name: Check Nessus Agent
    command: "{{ nessus_agent_check_cmd }}"
    become: yes
    changed_when: false
    ignore_errors: yes
    register: check_result

  - name: Start Nessus Agent
    service:
      name: nessusagent
      state: started
      enabled: yes
    become: yes
    when: check_result.stdout is search('Not linked to')

  - name: Make sure a service is running
    systemd:
      state: started
      name: httpd
    changed_when: false
    ignore_errors: yes
    register: nessus_agent_status

  - name: Link Nessus Agent to Nessus Manager
    command: "{{ nessus_agent_link_cmd }}"
    become: yes
    when: check_result.stdout is search('Not linked to')
  when: nessus_manage